generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  PATIENT
  DOCTOR
  NURSE
  ADMIN
  FAMILY
}

model User {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  password  String
  name      String
  blockchainId String? @unique
  role      Role     @default(PATIENT)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  patient   Patient?
  relations UserPatientRelation[]
  doctor    Doctor?
  auditLogs AuditLog[]
  guardianConsents PatientConsent[] @relation("GuardianConsents")  // C14: Consents I have
  grantedConsents  PatientConsent[] @relation("GrantedConsents")   // C14: Consents I granted
  acknowledgedEmergencies EmergencyAlert[] // Finding #14: Emergencies I acknowledged
  conflictResolutions ConflictResolutionLog[] // Production Blocker #3: Conflicts I resolved
}

model Patient {
  id        Int      @id @default(autoincrement())
  userId    Int      @unique
  user      User     @relation(fields: [userId], references: [id])
  mrn       String   @unique
  dob       DateTime
  gender    String
  bed       String?
  ward      String?
  riskScore Float?   @default(0)
  diagnosis String?
  
  weight    String?
  status    String?
  symptoms  String?
  
  painLevel      Int?
  painReportedAt DateTime?
  
  latestVitals Json?
  
  medications     Medication[]
  appointments    Appointment[]
  history         PatientHistory[]
  alerts          Alert[]
  relations       UserPatientRelation[]
  conversations   Conversation[]
  careTasks       CareTask[]
  consents        PatientConsent[]
  emergencyAlerts EmergencyAlert[]  // Finding #14
  
  version         Int       @default(1)  // Finding #7: Optimistic locking
  metadata Json?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model UserPatientRelation {
  id        Int      @id @default(autoincrement())
  userId    Int
  patientId Int
  relation  String
  createdAt DateTime @default(now())
  
  user    User    @relation(fields: [userId], references: [id])
  patient Patient @relation(fields: [patientId], references: [id])
  
  @@unique([userId, patientId])
}

model Medication {
  id        Int      @id @default(autoincrement())
  patientId Int
  name      String
  dosage    String
  frequency String?
  createdAt DateTime @default(now())
  
  patient Patient @relation(fields: [patientId], references: [id])
}

model PatientHistory {
  id        Int      @id @default(autoincrement())
  patientId Int
  entry     String
  createdAt DateTime @default(now())
  
  patient Patient @relation(fields: [patientId], references: [id])
}

model Alert {
  id        Int      @id @default(autoincrement())
  patientId Int
  type      String
  message   String
  severity  String
  resolved  Boolean  @default(false)
  timestamp DateTime @default(now())

  patient   Patient  @relation(fields: [patientId], references: [id])
}

model Doctor {
  id            Int           @id @default(autoincrement())
  userId        Int?          @unique
  name          String
  specialty     String
  email         String        @unique
  appointments  Appointment[]
  conversations Conversation[]
  createdAt     DateTime      @default(now())
  
  user          User?         @relation(fields: [userId], references: [id])
}

model Appointment {
  id        Int      @id @default(autoincrement())
  patientId Int
  doctorId  Int
  dateTime  DateTime
  status    String   @default("scheduled")
  type      String   @default("consultation")
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  patient Patient @relation(fields: [patientId], references: [id])
  doctor  Doctor  @relation(fields: [doctorId], references: [id])

  @@map("appointments")
}

enum TaskPriority {
  CRITICAL
  HIGH
  ROUTINE
  LOW
}

enum TaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  SKIPPED
}

// C14: Patient Consent Management for HIPAA Compliance
model PatientConsent {
  id            Int       @id @default(autoincrement())
  patientId     Int
  guardianId    Int       // User ID of family member
  consentType   String    // VIEW_VITALS, VIEW_MEDS, VIEW_CHAT, MODIFY_CARE_PLAN
  grantedAt     DateTime  @default(now())
  revokedAt     DateTime?
  grantedBy     Int       // User ID who granted (usually patient themselves)
  
  patient       Patient   @relation(fields: [patientId], references: [id])
  guardian      User      @relation("GuardianConsents", fields: [guardianId], references: [id])
  grantor       User      @relation("GrantedConsents", fields: [grantedBy], references: [id])
  
  @@unique([patientId, guardianId, consentType])
  @@index([guardianId, consentType])
  @@map("patient_consents")
}

model CareTask {
  id          Int          @id @default(autoincrement())
  patientId   Int
  title       String
  description String?
  priority    TaskPriority @default(ROUTINE)
  status      TaskStatus   @default(PENDING)
  dueTime     DateTime?
  completedAt DateTime?
  completedBy String?
  notes       String?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  
  patient     Patient      @relation(fields: [patientId], references: [id])
  
  @@index([patientId, status])
  @@index([dueTime])
  @@map("care_tasks")
}

model Conversation {
  id             Int       @id @default(autoincrement())
  patientId      Int
  doctorId       Int
  lastMessageAt  DateTime  @default(now())
  createdAt      DateTime  @default(now())
  
  patient        Patient   @relation(fields: [patientId], references: [id])
  doctor         Doctor    @relation(fields: [doctorId], references: [id])
  messages       Message[]
  
  @@unique([patientId, doctorId])
  @@index([lastMessageAt])
  @@map("conversations")
}

model Message {
  id             Int          @id @default(autoincrement())
  conversationId Int
  senderId       Int
  senderType     String       // C4: PATIENT, DOCTOR, NURSE, FAMILY
  content        String
  type           String       @default("TEXT")
  linkedVitalsId Int?
  sequence       Int          // Finding #6: Server-assigned sequence for ordering
  idempotencyKey String?      @unique // Finding #5: Prevent duplicate sends
  createdAt      DateTime     @default(now())
  
  conversation   Conversation @relation(fields: [conversationId], references: [id])
  
  @@index([conversationId, createdAt])
  @@map("messages")
}

// C10: Audit Trail for HIPAA Compliance
model AuditLog {
  id          Int      @id @default(autoincrement())
  userId      Int
  userRole    String
  action      String
  entityType  String
  entityId    Int?
  changes     Json
  ipAddress   String?
  timestamp   DateTime @default(now())
  
  user        User     @relation(fields: [userId], references: [id])
  
  @@index([userId, timestamp])
  @@index([entityType, entityId])
  @@index([action, timestamp])
  @@map("audit_logs")
}

// Production Blocker #3: Conflict Resolution Audit Log (Legal Compliance)
model ConflictResolutionLog {
  id              Int      @id @default(autoincrement())
  userId          Int
  userRole        String
  entityType      String   // PATIENT, MEDICATION, etc.
  entityId        Int
  
  // Conflict details
  expectedVersion Int
  currentVersion  Int
  conflictFields  Json     // Array of conflicting field names
  
  // Resolution details
  yourData        Json     // Data user tried to save
  serverData      Json     // Current server data
  resolvedData    Json     // Final merged data
  
  // Audit
  detectedAt      DateTime @default(now())
  resolvedAt      DateTime
  ipAddress       String?
  
  user            User     @relation(fields: [userId], references: [id])
  
  @@index([userId, detectedAt])
  @@index([entityType, entityId])
  @@map("conflict_resolution_logs")
}

// Finding #14: Emergency Alert Persistence for 100% Delivery Guarantee
model EmergencyAlert {
  id              Int       @id @default(autoincrement())
  patientId       Int
  severity        String    // CRITICAL, HIGH, MEDIUM, LOW
  vitalType       String    // HR, SPO2, BP, TEMP, FALL, MEDICATION
  value           String?
  notes           String?
  
  // Delivery tracking
  triggeredAt     DateTime  @default(now())
  deliveredVia    String?   // WEBSOCKET, PUSH, SMS
  deliveredAt     DateTime?
  acknowledgedBy  Int?
  acknowledgedAt  DateTime?
  
  // Retry tracking
  retryCount      Int       @default(0)
  lastRetryAt     DateTime?
  
  // Audit
  resolved        Boolean   @default(false)
  resolvedAt      DateTime?
  
  patient         Patient   @relation(fields: [patientId], references: [id])
  acknowledger    User?     @relation(fields: [acknowledgedBy], references: [id])
  
  @@index([patientId, triggeredAt])
  @@index([deliveredAt, acknowledgedAt])
  @@index([resolved])
  @@map("emergency_alerts")
}

// C8: Vitals Failure Logging
model VitalsFailureLog {
  id          Int       @id @default(autoincrement())
  patientId   Int
  vitalsData  Json
  error       String
  retryCount  Int       @default(0)
  resolvedAt  DateTime?
  createdAt   DateTime  @default(now())
  
  @@index([patientId, resolvedAt])
  @@map("vitals_failure_logs")
}
